define(function(){var e=angular.module("coreModule");e.service("BPConfig",function(){var e={apiUrl:"/api"};return e}),e.filter("split",function(){return function(e,t,n){return e.split(t)[n]}}).filter("capitalize",function(){return function(e,t){return e?e.replace(/([^\W_]+[^\s-]|[^\&_]*) */g,function(e){return e.charAt(0).toUpperCase()+e.substr(1)}):""}}).filter("encode",["$base64",function(e){return function(t,n){if(n)var r=t+"$"+n;else var r=t;return e.encode(r)}}]),e.factory("focus",["$timeout",function(e){return function(t){e(function(){var e=document.getElementById(t);e&&e.focus()})}}]).factory("blur",["$timeout",function(e){return function(t){e(function(){var e=document.getElementById(t);e&&e.blur()})}}]),e.factory("searchTypeahead",[function(){return function(){var e=getUrlParameter("q");$(".searchText").val(decodeURIComponent(e));var t=function(e){var t=$.map(e[1],function(e){return{value:e[0]}});return t},n=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"http://suggestqueries.google.com/complete/search?client=youtube&hl=en&sugexp=gsnos%2Cn%3D13&gs_ri=youtube&ds=yt&q=%QUERY",ajax:{type:"GET",dataType:"jsonp"},filter:t}});n.initialize(),$(".searchText").typeahead({hint:!0,highlight:!0,minLength:1},{name:"results",displayKey:"value",source:n.ttAdapter()});var r=function(e,t,n){angular.element(".searchForm").scope().search(t.value)},a=function(e,t,n){$(".searchText").keyup(function(e){13==e.keyCode&&angular.element(".searchForm").scope().search(t.value)})};$(".searchText").on("typeahead:autocompleted",a).on("typeahead:selected",r).keyup(function(e){13==e.keyCode&&angular.element(".searchForm").scope().search($(".searchText").val())}),$(".searchSubmit").on("click",function(){angular.element(".searchForm").scope().search($(".searchText").val())})}}]).factory("isEmptyObject",[function(){return function(e){for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}}]).factory("arrayObjectIndexOf",[function(){return function(e,t,n){for(var r=0,a=e.length;a>r;r++)if(e[r][n]===t)return r;return-1}}]).factory("navegatorIdentifier",[function(){return function(e){var t=navigator.userAgent.toLowerCase(),n=t.split("(");if(n){if(e){var r=t.search(" firefox"),a=t.search(" chrome"),i=t.search(" opr"),o=t.search(" safari");return r>=0?"firefox":i>=0?"opera":a>=0?"chrome":o>=0?"safari":null}var l=n[1].split(";");return l[0]}return null}}]),e.factory("player",[function(){return function(e,t,n){function r(e,t){for(var n=e.split("&"),r=0;r<n.length;r++){var a=n[r].split("=");if(a[0]==t)return a[1]}return""}if("getParams"==n){var a=document.getElementById("BPplayer"),i=a.getAttribute("src").split("?"),o=r(i[1],"playlist"),l=r(i[1],"repeat"),t=r(i[1],"kind"),s=r(i[1],"bp"),c=r(i[1],"id");return{id:c,playlist:o,repeat:l,kind:t,BPpl:s}}if("repeat"!=e)var c="id="+e;else var c="repeat=1";var a=document.getElementById("player");if("repeat"!=e)if(0==t)var u="player.html?"+c+"&kind=yt";else if(1==t)var u="player.html?"+c+"&playlist=1&kind=yt";else if(2==t)var u="player.html?"+c+"&kind=sc";else var u="player.html?"+c+"&playlist=1&kind=sc";else var u="player.html?"+c;if("null"!=n){var d=n.split("$");if("playlist"==d[0])var f=u+"&bp="+d[1]}else var f=u;var p={};p.timeField="00:00 / 00:00",p.timePercentage=0,playerChange("changeTime",p);var y="100%",h="100%";a.innerHTML='<iframe width="'+y+'" height="'+h+'" src="'+f+'" frameborder="0" id="BPplayer" allowfullscreen="1"></iframe>'}}]).controller("Player",["$scope","$element","$location","$http","player","$rootScope","$translate","$translatePartialLoader","$timeout","$auth",function(e,t,n,r,a,i,o,l,s,c){function u(e){i.isPlaying=1==e?!0:!1}function d(t){o("Player").then(function(t){e.Player=t}),o("big_small").then(function(t){e.big_small=t}),s(function(){var n=e.Player+"$"+e.big_small;if("null"!=t){var r=t.split("$");if("playlist"==r[2]){i.kindPlayer="playlist";var o=r[2]+"$"+r[3]}else{i.kindPlayer="search";var o="null"}"repeat"==r[0]?(a("repeat",0,o,n),u(1)):"youtube"==r[0]?(a(r[1],0,o,n),u(1)):"soundcloud"==r[0]?(a(r[1],2,o,n),u(1)):(a(r[1],1,o,n),u(1))}},10)}e.sync=function(){};l.addPart("player"),o.refresh(),e.repeatAll=function(e){console.log("repeat")},e.playerChangeState=function(t){e.playerState=t,e.$digest()},e.next=function(){var e=a("","","getParams"),t=e.BPpl,n=e.kind,o=e.playlist,l=e.id;if("yt"==n)if(1==o)var s="YTplaylist$"+l;else var s="youtube$"+l;else if("sc"==n)var s="soundcloud$"+l;var c=i.kindPlayer;if("search"==c){var f=i.mergedItems,p=0;for(items in f)p++;if(0!=p){var y=f.indexOf(s);f.splice(y,1);var e=f[0],h=i.prevMergedItems;h.push(s),d(e)}else{i.mergedItems=i.prevMergedItems,i.prevMergedItems=[];var e=f[0];d(e)}}else t?r.get(APIurl+"/playlists/"+t+"/next/"+s).then(function(e){if(e.data.finished){var n="repeat$1$playlist$"+t;d(n)}else{var n=e.data.id+"$playlist$"+t;d(n)}}):(u(0),a(null,null,"destroy"))},e.prev=function(e,t,n,o){var l=a("","","getParams"),e=l.BPpl,t=l.kind,n=l.playlist,o=l.id;if("yt"==t)if(1==n)var s="YTplaylist$"+o;else var s="youtube$"+o;else if("sc"==t)var s="soundcloud$"+o;var c=i.kindPlayer;if("search"==c){var f=i.prevMergedItems,p=0;for(items in f)p++;if(0!=p){var y=0;for(items in f){if(y+1==p){var l=f[y],h=i.mergedItems;h.push(f[y]),f.splice(y,1),d(l)}y++}}else{var l=h[0];d(l)}}else e?r.get(APIurl+"/playlists/"+e+"/prev/"+s).then(function(t){if(t.data.finished){var n="repeat$1$playlist$"+e;d(n)}else{var n=t.data.id+"$playlist$"+e;d(n)}}):(u(0),a(null,null,"destroy"))},u(),e.play=function(e,n){var r=angular.element(t),a=$(r).attr("url");d(a)},e.playPlayer=function(){var e=document.getElementById("BPplayer");e&&e.contentWindow.play()},e.pausePlayer=function(){var e=document.getElementById("BPplayer");e&&e.contentWindow.pause()},e.mutePlayer=function(){var t=document.getElementById("BPplayer");t&&(t.contentWindow.mute(),e.playerVolume=0)},e.unMutePlayer=function(){var t=document.getElementById("BPplayer");t&&(t.contentWindow.unMute(),e.playerVolume=1)};var f=document.getElementById("time_line_bar_container"),p=time_line_bar_container.getBoundingClientRect().left;e.seekToPlayer=function(e,t){var n=window.getComputedStyle(f).getPropertyValue("width");n=parseFloat(n.substr(0,n.length-2));var r=e.clientX-p;if(r>n)var a=n;else if(0>r)var a=0;else var a=r;var i=document.getElementById("BPplayer");i&&(e.isEnd?i.contentWindow.seekTo(a/n,1):i.contentWindow.seekTo(a/n,0))},e.destroy=function(){o("Player").then(function(t){e.Player=t}),s(function(){u(0),a(null,null,"destroy",e.Player)},10)}}]),e.directive("include",["$http","$templateCache","$compile",function(e,t,n){return{restrict:"A",link:function(r,a,i){var o=r.$eval(i.include);e.get(o,{cache:t}).success(function(e){a.replaceWith(n(e)(r))})}}}]).directive("showFocus",["$timeout",function(e){return function(t,n,r){t.$watch(r.showFocus,function(t){e(function(){t&&n[0].focus()})},!0)}}]),e.directive("ngEnter",function(){return function(e,t,n){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(n.ngEnter)}),t.preventDefault())})}}),e.service("userService",["$http","$auth","toastr","navegatorIdentifier","BPConfig","navegatorIdentifier","searchTypeahead",function(e,t,n,r,a,r,i){var o=a.apiUrl,l=!0,s={};return s.loadInfo=function(t){e.defaults.headers.common.device=r(),e.defaults.headers.common.browser=r(1),e.get(o+"/user/me").then(function(e){i(),t(e.data)})["catch"](function(e,t){n.error("Unexpected error "+e.data)})["finally"](function(){$("#loading").hide()})},s.logout=function(t){e.get(o+"/user/logout").then(function(){t()})["catch"](function(e,t){n.error("Unexpected error "+e.data)})["finally"](function(){$("#loading").hide()})},s.loginSocket=function(e){l&&(io.socket.on("report",function(e){e.response&&s.socketNotify(e.id)}),l=!1),io.socket.request({method:"get",url:o+"/user/me",headers:{authorization:"Bearer "+t.getToken(),browser:r(1),device:r()}},function(t,n){e(t)})},s.socketNotify=function(e){io.socket.request({method:"GET",url:o+"/user/notifyNewSocket",headers:{authorization:"Bearer "+t.getToken(),browser:r(1),device:r(),toNotify:e}})},s}]),e.service("playlistsService",["$http","toastr","BPConfig","getCSRF",function(e,t,n,r){var a={},i=n.apiUrl;return a.load=function(n){e.get(i+"/playlists/me").then(function(e){n(e.data)})["catch"](function(e,n){t.error("Unexpected error "+e.data)})["finally"](function(){$("#loading").hide()})},a.create=function(n,a){r(function(r){e.post(i+"/playlists/create",{title:n,_csrf:r}).then(function(e){e.data.err&&t.warning(e.data.err),a(e.data)})["catch"](function(e,n){t.error("Unexpected error "+e.data)})})},a["delete"]=function(n){r(function(r){e.post(i+"/playlists/delete",{id:n,_csrf:r}).then(function(e){e.data.err&&t.warning(e.data.err)})["catch"](function(e,n){t.error("Unexpected error, the playlists didn't save the changes.")})})},a.reOrder=function(n,a,o){r(function(r){e.post(i+"/playlists/"+n+"/items/reorder",{Items:a,_csrf:r}).then(function(e){t.success("changes_saved."),o("yeah!")})["catch"](function(e,n){t.error("Unexpected error, the playlists didn't save the changes.")})})},a.addOrDeleteItem=function(n,a,o,l){r(function(r){e.post(i+"/playlists/item/addOrDeleteItem",{PLId:n,item:o,title:a,_csrf:r}).then(function(e){e.data.err&&t.warning(e.data.err)})["catch"](function(e,n){t.error("Unexpected error "+e.data)})})},a.changeItem=function(e,t,n,r){var a=n.indexOf(t);if(e!=a+1){var i,o=n.length-1;i=1>=e?0:e>o?o:e-1;var l=[],s=0;angular.forEach(n,function(e){l.push(a>i?s==i?t:i>s?e:s>a?e:n[s-1]:s==i?t:a>s?e:i>s?n[s+1]:s>a?e:n[s-1]),s==o&&r(l),s++})}},a}]),e.service("searchService",["$http","toastr","arrayObjectIndexOf",function(e,t,n){var r={};return r.youtube=function(r,a,i,o){if(!a)var a="null";e.get(APIurl+"/youtube/search/"+r+"/"+a).then(function(e){if(i){var t={};for(result in e.data.items){for(playlist in i){var r=n(i[playlist].items,e.data.items[result],"id");if(r>-1){var a=i[playlist].items[r].id,l=i[playlist].id;t[l]||(t[l]={}),t[l][a]=!0}}result==e.data.items.length-1&&(e.data.exist=t,o(e.data))}}else o(e.data)})["catch"](function(e,n){t.error("Unexpected error "+e.data)})["finally"](function(){$("#loading").hide()})},r.soundcloud=function(r,a,i,o){if(!l)var l="null";e.get(APIurl+"/soundcloud/search/"+r+"/"+l).then(function(e){if(i){var t={};for(result in e.data.items){for(playlist in i){var r=n(i[playlist].items,e.data.items[result],"id");if(r>-1){var a=i[playlist].items[r].id,l=i[playlist].id;t[l]||(t[l]={}),t[l][a]=!0}}result==e.data.items.length-1&&(e.data.exist=t,o(e.data))}}else o(e.data)})["catch"](function(e,n){t.error("Unexpected error "+e.data)})["finally"](function(){$("#loading").hide()})},r}]),e.controller("mainController",["$scope","$auth","$translatePartialLoader","$location","$filter","toastr","userService","playlistsService","BPConfig","arrayObjectIndexOf",function(e,t,n,r,a,i,o,l,s,c){function u(){e.domAction.element="Identifying user...",o.loadInfo(function(t){e.userInfo=t,t.picture||(e.userInfo.picture="/assets/img/userDefault.png"),e.domAction.element="Loading your playlists...",l.load(function(t){var n=a("orderBy")(t,"title");e.playlists=n;var o=r.search().playlist;if(e.createNewPLFocus=!0,e.createPlaylist=function(t,n,r,o){e.createNewPLDisable=!0,e.createNewPLFocus=!1;var s=c(e.playlists,t.toLowerCase(),"title");-1==s?l.create(t,function(t){if(e.createNewPLDisable=!1,e.createNewPLFocus=!0,!t.err){var i=e.playlists;i.push(t);var o=a("orderBy")(i,"title");e.playlists=o,e.addOrDeleteItem(t,n,r)}}):(i.warning("The playlist "+t+" already exist."),e.createNewPLDisable=!1,e.createNewPLFocus=!0)},e.deletePlaylist=function(t){var n=e.playlists.indexOf(t);console.log(n),n>-1&&(l["delete"](t.id),e.playlists.splice(n,1),i.error(t.title+" was deleted"))},e.changeItem=function(t,n){l.changeItem(t,n,e.playlists[e.PLDetailsindex].items,function(t){e.playlists[e.PLDetailsindex].items=t,e.showSaveButton=!0})},e.reOrder=function(t,n){l.reOrder(e.playlists[e.PLDetailsindex].id,e.playlists[e.PLDetailsindex].items),e.showSaveButton=!1},e.addOrDeleteItem=function(t,n,r){var a=e.playlists.indexOf(t);l.addOrDeleteItem(t.id,n,r);var o=c(t.items,r,"id");o>-1?(e.playlists[a].items.splice(o,1),i.error(n+" was deleted from "+t.title)):(e.playlists[a].items.push({id:r,title:n}),i.success(n+" was added to "+t.title))},"/"==r.path()&&e.playlists.length>0)if(o){var s=n.map(function(e){return e.id}).indexOf(o);if(s>-1){var u=n[s];e.loadPlaylistDetails(u)}else e.loadPlaylistDetails(n[0])}else e.loadPlaylistDetails(n[0]);e.domAction.loading=!1})}),e.loadPlaylistDetails=function(t){if(t){r.path("/").search({playlist:t.id});var n=e.playlists.indexOf(t);e.PLDetailsindex=n}else{t=e.playlists[0],r.path("/").search({playlist:t.id});var n=e.playlists.indexOf(t);e.PLDetailsindex=0}},e.logout=function(){o.logout(function(n){e.playlists="",t.logout()})}}n.addPart("head"),n.addPart("home"),n.addPart("playlists"),n.addPart("search"),e.isAuthenticated=t.isAuthenticated,e.domAction={},e.domAction.loading=!0;e.domAction.element="Loading dom...",e.isAuthenticated()||(e.domAction.loading=!1),e.$watch("isAuthenticated()",function(){e.isAuthenticated()&&u()})}]),e.controller("headController",["$scope","$http","$translate","$location","$auth","focus","blur","BPConfig",function(e,t,n,r,a,i,o,l){l.apiUrl;e.search=function(t){t&&(r.path("/search").search({q:t}),e.searchText=r.search().q,o("searchText"))}}]),e.directive("showFocus",["$timeout",function(e){return function(t,n,r){t.$watch(r.showFocus,function(t){e(function(){t&&n.focus()})},!0)}}]).filter("encodeURIComponent",function(){return window.encodeURIComponent}).filter("decodeURIComponent",function(){return window.decodeURIComponent}).controller("playlistsController",["$scope","$rootScope","$translate","$filter","$http","$location","getCSRF","BPConfig","playlistsService","toastr",function(e,t,n,r,a,i,o,l,s,c){i.search().playlist}])});